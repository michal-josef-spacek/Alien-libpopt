use alienfile;
use Path::Tiny ();

if ($^O eq 'MSWin32') {
	my $libdir = Path::Tiny->new($^X)->parent->parent->parent->child('c/lib');
	my $program = <<'END';
#include <popt.h>
int main()
{
	return 0;
}
END
	plugin 'Probe::CBuilder' => (
		libs => '-lpopt',
		program => $program,
	);
	plugin 'Probe::CBuilder' => (
		libs => '-L$libdir -lpopt',
		program => $program,
	);

} else {
	plugin 'PkgConfig' => 'popt';
}

share {
	# XXX Fix https on Windows.
	my $proto = $^O eq 'MSWin32' ? 'http' : 'https';
	start_url $proto.'://ftp.rpm.org/popt/releases/popt-1.x/';;
	plugin Download => (
		filter => qr/^popt-.*\.tar\.gz$/,
		version => qr/^popt-([0-9\.]+)/,
		bootstrap_ssl => 1,
	);

	plugin 'Extract' => 'tar.gz';
	plugin 'Build::Make' => 'gmake';
	plugin 'Build::Autoconf';
	build [
		'%{configure} --enable-static --enable-shared',
		'%{make}',
		'%{make} install',
	];
	plugin 'Gather::IsolateDynamic';
};
